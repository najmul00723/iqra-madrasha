<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶á‡¶ï‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Bangla:ital@0;1&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ï‡¶ø‡¶Æ --- */
        :root {
            --primary-green: #28a745;
            --text-red: #dc3545;
            --dark-color: #212529;
            --light-color: #ffffff;
            --background-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tiro Bangla', serif;
            background-color: var(--background-color);
            color: var(--dark-color);
            line-height: 1.6;
            position: relative; /* ‡¶ì‡¶Ø‡¶º‡¶æ‡¶ü‡¶æ‡¶∞‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï */
            padding-bottom: 60px; /* ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ */
        }
        
        /* --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ì‡¶Ø‡¶º‡¶æ‡¶ü‡¶æ‡¶∞‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶≤‡ßã‡¶ó‡ßã --- */
        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50vw;
            max-width: 300px;
            height: 50vw;
            max-height: 300px;
            background-image: url('images/logo.png'); /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ó‡ßã‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶® */
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            opacity: 0.08;
            z-index: -1; /* ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶™‡ßá‡¶õ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        }

        /* --- ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶≤‡ßá‡¶Ü‡¶â‡¶ü --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® --- */
        header {
            background: var(--light-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-area img {
            height: 60px;
            width: 60px;
        }
        .logo-area .title-info .logo-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-red);
            margin: 0;
            line-height: 1.2;
        }
        .logo-area .title-info .logo-subtitle {
            font-size: 0.9rem;
            color: var(--dark-color);
            margin: 0;
        }

        /* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® --- */
        nav {
            display: flex;
            gap: 5px;
        }
        nav .btn {
            background: none;
            border: none;
            color: var(--dark-color);
            font-weight: normal;
            padding: 10px 15px;
            position: relative;
            transition: color 0.3s ease;
        }
        nav .btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: var(--primary-green);
            transition: width 0.3s ease;
        }
        nav .btn:hover, nav .btn.active-nav {
            color: var(--primary-green);
        }
        nav .btn:hover::after, nav .btn.active-nav::after {
            width: 100%;
        }
        nav .btn-primary, nav .btn-danger {
            color: var(--light-color);
            border-radius: 20px;
        }
        nav .btn-primary { background-color: var(--primary-green); }
        nav .btn-danger { background-color: var(--text-red); }
        nav .btn-primary:hover, nav .btn-danger:hover {
            opacity: 0.9;
        }
        nav .btn-primary::after, nav .btn-danger::after {
            display: none;
        }

        /* --- ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ ‡¶¨‡¶æ ‡¶≠‡¶ø‡¶â --- */
        .view { display: none; }
        .view.active { display: block; }

        #login-view-container {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 3000;
        }
        #login-view-container.active { display: flex; justify-content: center; align-items: center; }
        .login-box {
            width: 100%; max-width: 400px; padding: 2rem; background: var(--light-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; text-align: center;
        }
        .login-box .logo-title { margin-bottom: 1rem; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 1rem; border: 1px solid var(--border-color);
            border-radius: 5px; font-family: 'Tiro Bangla', serif; font-size: 1rem;
        }
        .btn-generic {
            display: inline-block; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 1rem; font-weight: bold; text-align: center; transition: background-color 0.3s ease;
        }
        .btn-primary.btn-generic { background-color: var(--primary-green); color: var(--light-color); }
        .btn-danger.btn-generic { background-color: var(--text-red); color: var(--light-color); }
        .btn-secondary.btn-generic { background-color: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .action-btn-group button { margin-left: 5px; }

        .card {
            background: var(--light-color); padding: 20px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .card h2, .card h3 { margin-bottom: 1rem; color: var(--primary-green); }
        .card-header { display: flex; justify-content: space-between; align-items: center; }

        #latest-notice-card { border-left: 5px solid var(--primary-green); }
        #old-notices-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .old-notice-card { position: relative; cursor: pointer; transition: transform 0.2s; }
        .old-notice-card:hover { transform: translateY(-5px); }
        
        /* --- ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® --- */
        .class-list {
            list-style: none;
            padding: 15px 0 0 0; /* ‡¶â‡¶™‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶ø‡¶Ç */
            margin-top: 10px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px; /* ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ */
        }
        .class-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 20px; /* ‡§ó‡•ã‡§≤‡§æ‡§ï‡§æ‡§∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ */
            padding: 8px 15px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            gap: 10px; /* ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ */
        }
        .class-list li:hover {
            border-color: var(--primary-green);
            background-color: #e9f5e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.1);
        }
        .class-list li .class-name-span {
            cursor: pointer;
            flex-grow: 1;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .student-list-container { display: flex; flex-direction: column; gap: 15px; }

        .search-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-box {
            flex-grow: 1;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 1rem;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }
        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.6;
        }
        .student-counter {
            font-weight: bold;
            color: var(--dark-color);
            background-color: #e9ecef;
            padding: 8px 15px;
            border-radius: 15px;
            white-space: nowrap;
        }
        .student-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary-green);
            box-shadow: 0 2px 5px rgba(0,0,0,0.07);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }
        .student-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateY(-3px);
        }

        .student-info { display: flex; align-items: center; gap: 15px; }
        .serial-number { font-size: 1.2rem; font-weight: bold; color: var(--primary-green); }
        .student-name { font-size: 1.1rem; font-weight: bold; color: var(--dark-color); margin: 0; }
        .father-name { font-size: 0.9rem; color: #6c757d; margin: 0; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; flex-wrap: wrap; }
        .tab-link {
            padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1rem;
            font-family: 'Tiro Bangla', serif;
        }
        .tab-link.active { border-bottom: 2px solid var(--primary-green); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .funds-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .summary-card { text-align: center; padding: 20px; border-radius: 8px; border-left: 5px solid; }
        .summary-card h4 { font-size: 1rem; margin-bottom: 0.5rem; font-weight: normal; }
         .summary-card h2 { font-size: 1.8rem; margin: 0; }
        .summary-card.income { background-color: #d4edda; color: #155724; border-color: #4CAF50;}
        .summary-card.expense { background-color: #f8d7da; color: #721c24; border-color: #F44336;}
        .summary-card.balance { background-color: #d1ecf1; color: #0c5460; border-color: #03A9F4;}
        .summary-card.dues { background-color: #fff3cd; color: #856404; border-color: #FFC107;}
        .table-responsive-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: #e9ecef; }
        .admin-only, .student-only, .logged-in-only, .guest-only { display: none; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-green); border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888;
            width: 80%; max-width: 600px; border-radius: 8px; position: relative;
        }
        .close-btn {
            color: #aaa; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        
        .funds-summary .summary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .funds-summary .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .professional-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95rem;
        }
        .professional-table th, .professional-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .professional-table thead th {
            background-color: #f1f3f5;
            font-weight: bold;
            color: var(--dark-color);
        }
        .professional-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .professional-table tbody tr:hover {
            background-color: #e9ecef;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        #settings-form input {
            max-width: 300px;
        }

        .hamburger-menu {
            display: none;
            cursor: pointer;
        }
        .hamburger-menu div {
            width: 25px; height: 3px; background-color: var(--dark-color);
            margin: 5px 0; transition: 0.4s;
        }

        .card-header.centered-card-header {
            justify-content: center;
            position: relative;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .card-header.centered-card-header h2 {
            margin-bottom: 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-green);
            display: inline-block;
        }
        .card-header.centered-card-header .admin-only {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü: ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        #contact-info-section {
            background-color: #f0fdf4;
            border: 1px solid var(--primary-green);
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: -10px;
            margin-bottom: 20px;
        }
        .contact-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
            width: 100%;
        }
        .contact-list {
            width: 100%;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .contact-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9f5e9;
            flex-wrap: wrap;
            gap: 10px;
        }
        .contact-list li:last-child {
            border-bottom: none;
        }
        .contact-details {
            font-size: 1rem;
        }
        .contact-admin-controls {
            width: 100%;
            text-align: right;
            margin-top: 15px;
        }

        /* --- ‡¶´‡ßÅ‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        footer {
            background-color: var(--dark-color);
            color: #ccc;
            text-align: center;
            padding: 15px 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
            font-size: 0.9rem;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        footer p {
            margin: 0;
        }
        footer b {
            color: var(--light-color);
        }

        @media (max-width: 992px) {
              header {
                  padding: 0.75rem 1rem;
              }
            .hamburger-menu {
                display: block;
            }
            nav {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--light-color);
                flex-direction: column;
                align-items: center;
                padding: 1rem 0;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            nav.nav-visible {
                display: flex;
            }
            nav .btn {
                width: 100%;
                text-align: center;
                border-bottom: 1px solid var(--border-color);
            }
            nav .btn:last-child {
                border-bottom: none;
            }
             .modal-content {
                 width: 95%;
                 margin: 20% auto;
             }
        }
        @media (max-width: 768px) {
            .funds-summary {
                grid-template-columns: 1fr;
            }
            .professional-table th, .professional-table td {
                padding: 10px 8px;
            }
             /* --- ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ì ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® --- */
            .card-header.centered-card-header {
                flex-direction: column;
                gap: 15px;
                padding-bottom: 15px;
            }
            .card-header.centered-card-header .admin-only {
                position: static;
                transform: none;
                width: 100%;
                display: flex;
                justify-content: center;
            }
            .card-header.centered-card-header .admin-only button {
                width: auto;
                flex-grow: 1;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="logo-area">
                <img src="images/logo.png" alt="‡¶á‡¶ï‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ ‡¶≤‡ßã‡¶ó‡ßã">
                <div class="title-info">
                    <h1 class="logo-title">‡¶á‡¶ï‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
                    <p class="logo-subtitle">‡¶¨‡ßá‡¶ó‡¶Æ‡¶™‡ßÅ‡¶∞, ‡¶Æ‡¶π‡ßá‡¶∂‡¶™‡ßÅ‡¶∞, ‡¶ù‡¶ø‡¶®‡¶æ‡¶á‡¶¶‡¶π</p>
                </div>
            </div>
            <nav id="main-nav">
                <button class="btn active-nav" id="home-btn">‡¶π‡ßã‡¶Æ</button>
                <button class="btn" id="dashboard-btn">‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
                <button class="btn" id="about-btn">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá</button>
                <button class="btn admin-only" id="funds-btn">‡¶§‡¶π‡¶¨‡¶ø‡¶≤</button>
                <button class="btn admin-only" id="settings-btn">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
                <button class="btn btn-primary guest-only" id="show-login-btn">‡¶≤‡¶ó‡¶á‡¶®</button>
                <button class="btn btn-danger logged-in-only" id="logout-btn">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </nav>
            <div class="hamburger-menu" id="hamburger-menu">
                <div></div>
                <div></div>
                <div></div>
            </div>
        </header>
        <main class="container">
            <div id="notice-view" class="view"></div>
            <div id="about-view" class="view"></div> 
            <div id="dashboard-view" class="view"></div>
            <div id="class-view" class="view"></div>
            <div id="student-view" class="view"></div>
            <div id="funds-view" class="view"></div>
            <div id="settings-view" class="view"></div>
        </main>
    </div>

    <div id="login-view-container" class="view">
        <div class="login-box">
             <h1 class="logo-title">‡¶á‡¶ï‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ</h1>
             <p>‡¶¨‡ßá‡¶ó‡¶Æ‡¶™‡ßÅ‡¶∞, ‡¶Æ‡¶π‡ßá‡¶∂‡¶™‡ßÅ‡¶∞, ‡¶ù‡¶ø‡¶®‡¶æ‡¶á‡¶¶‡¶π</p>
            <hr style="margin: 1rem 0;">
            <input type="email" id="login-email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
            <input type="password" id="login-password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
            <button id="login-btn" class="btn-generic btn-primary" style="width: 100%;">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button id="close-login-btn" class="btn-generic btn-secondary" style="width: 100%; margin-top: 10px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <p id="login-error" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="main-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 <b>Iqra Madrasha</b> | App Created with <b>Najmul Bin Jalal uddin</b></p>
    </footer>

    <script type="module">
        // Firebase v9+ modular SDK import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, enableIndexedDbPersistence, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶ú ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ---
        const firebaseConfig = {
            apiKey: "AIzaSyCiidSshIgw4kHdP5dTPH6HO2yXNgFH_0Q",
            authDomain: "iqra-madrasa.firebaseapp.com",
            projectId: "iqra-madrasa",
            storageBucket: "iqra-madrasa.appspot.com",
            messagingSenderId: "208725420335",
            appId: "1:208725420335:web:25ed801ad8d14d5c8459da"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => console.error(err.code));

        let currentUser = null;
        let userRole = 'guest';
        let gradingSettings = null;

        const loginContainer = document.getElementById('login-view-container');
        const views = document.querySelectorAll('.view');
        const modal = document.getElementById('main-modal');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.querySelector('.close-btn');
        const nav = document.getElementById('main-nav');
        const hamburger = document.getElementById('hamburger-menu');
        const navButtons = nav.querySelectorAll('.btn');

        hamburger.addEventListener('click', () => {
            nav.classList.toggle('nav-visible');
        });

        function setActiveNav(activeBtnId) {
            navButtons.forEach(btn => {
                if (btn.id === activeBtnId) {
                    btn.classList.add('active-nav');
                } else {
                    btn.classList.remove('active-nav');
                }
            });
            if (window.innerWidth < 992) {
                 nav.classList.remove('nav-visible');
            }
        }
        
        function updateUserUI() {
            document.querySelectorAll('.admin-only, .student-only, .logged-in-only, .guest-only').forEach(el => el.style.display = 'none');
            const visibleNavButtons = [];
            if (userRole === 'admin') {
                document.querySelectorAll('.admin-only, .logged-in-only').forEach(el => {
                    el.style.display = 'inline-block';
                    if (el.matches('nav .btn')) visibleNavButtons.push(el);
                });
            } else if (userRole === 'student') {
                document.querySelectorAll('.student-only, .logged-in-only').forEach(el => {
                     el.style.display = 'inline-block';
                     if (el.matches('nav .btn')) visibleNavButtons.push(el);
                });
            } else {
                document.querySelectorAll('.guest-only').forEach(el => {
                    el.style.display = 'inline-block';
                    if (el.matches('nav .btn')) visibleNavButtons.push(el);
                });
            }
            document.querySelectorAll('#home-btn, #about-btn, #dashboard-btn').forEach(btn => visibleNavButtons.push(btn));
        }

        function showView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        async function loadGradingSettings() {
            try {
                const settingsDoc = await getDoc(doc(db, 'settings', 'grading'));
                if (settingsDoc.exists()) {
                    gradingSettings = settingsDoc.data();
                } else {
                    gradingSettings = {
                        passMark: 40,
                        grades: { 'A+': 480, 'A': 420, 'A-': 360, 'B': 300, 'C': 240, 'D': 198 }
                    };
                }
            } catch (error) {
                console.error("Error loading grading settings:", error);
                gradingSettings = {
                    passMark: 40,
                    grades: { 'A+': 480, 'A': 420, 'A-': 360, 'B': 300, 'C': 240, 'D': 198 }
                };
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                userRole = userDoc.exists() ? userDoc.data().role : 'student';
                loginContainer.classList.remove('active');
                await loadGradingSettings();
            } else {
                currentUser = null;
                userRole = 'guest';
            }
            updateUserUI();
            renderNoticeBoard();
            showView('notice-view');
            setActiveNav('home-btn');
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            signInWithEmailAndPassword(auth, email, password).catch((error) => {
                errorP.textContent = '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§';
            });
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('show-login-btn').addEventListener('click', () => loginContainer.classList.add('active'));
        document.getElementById('close-login-btn').addEventListener('click', () => loginContainer.classList.remove('active'));
        
        document.getElementById('home-btn').addEventListener('click', () => { renderNoticeBoard(); showView('notice-view'); setActiveNav('home-btn'); });
        document.getElementById('about-btn').addEventListener('click', () => { renderAboutView(); showView('about-view'); setActiveNav('about-btn'); });
        document.getElementById('dashboard-btn').addEventListener('click', () => { renderDashboardView(); showView('dashboard-view'); setActiveNav('dashboard-btn'); });
        document.getElementById('funds-btn').addEventListener('click', () => { renderFundsView(); showView('funds-view'); setActiveNav('funds-btn'); });
        document.getElementById('settings-btn').addEventListener('click', () => { renderSettingsView(); showView('settings-view'); setActiveNav('settings-btn'); });


        function openModal(content) {
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }
        closeModalBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = 'none'; } }
        
        async function renderAboutView() {
            const view = document.getElementById('about-view');
            view.innerHTML = `<div class="loader"></div>`;
            try {
                const aboutDoc = await getDoc(doc(db, 'pages', 'about'));
                const content = aboutDoc.exists() ? aboutDoc.data().content : '‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§';
                
                view.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá</h2>
                            <button id="edit-about-btn" class="btn-generic btn-primary admin-only">‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                        <div id="about-content-display" style="white-space: pre-wrap; line-height: 1.8;">
                            ${content}
                        </div>
                    </div>`;

                updateUserUI();

                if (userRole === 'admin') {
                    document.getElementById('edit-about-btn').addEventListener('click', () => showEditAboutForm(content));
                }
            } catch (error) {
                console.error("Error fetching about page:", error);
                view.innerHTML = `<div class="card"><p>'‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá' ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p></div>`;
            }
        }

        function showEditAboutForm(currentContent) {
            openModal(`
                <h2>'‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá' ‡¶™‡ßá‡¶ú ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <textarea id="about-content-editor" rows="12">${currentContent}</textarea>
                <button id="save-about-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            `);

            document.getElementById('save-about-btn').addEventListener('click', async () => {
                const newContent = document.getElementById('about-content-editor').value;
                if (!newContent) {
                    return alert('‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
                }
                await setDoc(doc(db, 'pages', 'about'), { content: newContent }, { merge: true });
                modal.style.display = 'none';
                renderAboutView(); 
            });
        }
        
        async function renderDashboardView() {
            const view = document.getElementById('dashboard-view');
            view.innerHTML = `<div class="loader"></div>`;
            
            try {
                const branchesSnapshot = await getDocs(collection(db, 'branches'));
                let html = `<div class="card"><div class="card-header centered-card-header"><h2>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ)</h2><div class="admin-only"><button id="add-branch-btn" class="btn-generic btn-primary">‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ</button></div></div></div>`;
                
                if (branchesSnapshot.empty) {
                    html += '<div class="card"><p>‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p></div>'
                }

                let branchCardsHtml = '';
                for (const branchDoc of branchesSnapshot.docs) {
                    const branch = branchDoc.data();
                    const branchId = branchDoc.id;
                    
                    branchCardsHtml += `<div class="card branch-card"><div class="card-header"><h3>${branch.name}</h3><div class="admin-only action-btn-group"><button class="btn-generic btn-secondary btn-sm edit-branch-btn" data-id="${branchId}" data-name="${branch.name}">‡¶è‡¶°‡¶ø‡¶ü</button><button class="btn-generic btn-danger btn-sm delete-branch-btn" data-id="${branchId}">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button><button class="btn-generic btn-primary btn-sm add-class-btn" data-branch-id="${branchId}" data-branch-name="${branch.name}">‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</button></div></div><ul class="class-list" id="class-list-${branchId}"><li style="text-align:center;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</li></ul></div>`;
                    
                    getDocs(collection(db, `branches/${branchId}/classes`)).then(classesSnapshot => {
                        const classListEl = document.getElementById(`class-list-${branchId}`);
                        if (!classListEl) return;
                        classListEl.innerHTML = classesSnapshot.empty ? '<li style="width: 100%; background: none; box-shadow: none; border: none;">‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</li>' : '';
                        classesSnapshot.forEach(classDoc => {
                            const classData = classDoc.data();
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <span class="class-name-span">${classData.name}</span>
                                <div class="admin-only action-btn-group">
                                    <button class="btn-generic btn-secondary btn-sm edit-class-btn" data-branch-id="${branchId}" data-id="${classDoc.id}" data-name="${classData.name}">‡¶è‡¶°‡¶ø‡¶ü</button>
                                    <button class="btn-generic btn-danger btn-sm delete-class-btn" data-branch-id="${branchId}" data-id="${classDoc.id}">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
                                </div>
                            `;
                            li.querySelector('.class-name-span').onclick = () => renderClassView(branchId, classDoc.id, classData.name);
                            classListEl.appendChild(li);
                        });

                        if (userRole === 'admin') {
                            classListEl.querySelectorAll('.edit-class-btn').forEach(btn => btn.addEventListener('click', (e) => showEditClassForm(e.target.dataset.branchId, e.target.dataset.id, e.target.dataset.name)));
                            classListEl.querySelectorAll('.delete-class-btn').forEach(btn => btn.addEventListener('click', (e) => deleteClass(e.target.dataset.branchId, e.target.dataset.id)));
                        }
                        updateUserUI(); 
                    });
                }

                view.innerHTML = html + branchCardsHtml;
                updateUserUI();
                
                if (userRole === 'admin') {
                    document.getElementById('add-branch-btn').addEventListener('click', showAddBranchForm);
                    document.querySelectorAll('.add-class-btn').forEach(btn => btn.addEventListener('click', (e) => showAddClassForm(e.target.dataset.branchId, e.target.dataset.branchName)));
                    document.querySelectorAll('.edit-branch-btn').forEach(btn => btn.addEventListener('click', (e) => showEditBranchForm(e.target.dataset.id, e.target.dataset.name)));
                    document.querySelectorAll('.delete-branch-btn').forEach(btn => btn.addEventListener('click', (e) => deleteBranch(e.target.dataset.id)));
                }
            } catch (error) {
                console.error("Dashboard load error:", error);
                view.innerHTML = `<div class="card"><p>‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p></div>`;
            }
        }
        
        async function renderClassView(branchId, classId, className) {
            const view = document.getElementById('class-view');
            showView('class-view');
            view.innerHTML = `<div class="loader"></div>`;

            const studentsPath = `branches/${branchId}/classes/${classId}/students`;
            const studentsSnapshot = await getDocs(query(collection(db, studentsPath), orderBy('name')));

            let studentCardsHtml = '';
            if (studentsSnapshot.empty) {
                studentCardsHtml = '<p style="text-align:center; padding: 20px;">‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
            } else {
                let serial = 1;
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    studentCardsHtml += `
                        <div class="student-card" data-id="${doc.id}">
                            <div class="student-info">
                                <span class="serial-number">${serial++}.</span>
                                <div>
                                    <h4 class="student-name">${student.name}</h4>
                                    <p class="father-name">‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ: ${student.fatherName}</p>
                                </div>
                            </div>
                            <div class="admin-only action-btn-group">
                                <button class="btn-generic btn-secondary btn-sm edit-student-btn">‡¶è‡¶°‡¶ø‡¶ü</button>
                                <button class="btn-generic btn-danger btn-sm delete-student-btn">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
                            </div>
                        </div>
                    `;
                });
            }

            const studentCount = studentsSnapshot.docs.length;

            view.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>${className} - ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                        <div>
                            <button id="back-to-dashboard-btn" class="btn-generic btn-secondary">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
                            <button id="add-student-btn" class="btn-generic btn-primary admin-only">‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</button>
                        </div>
                    </div>
                    
                    <div class="search-controls">
                        <div class="search-box">
                            <input type="text" id="student-search-input" class="search-input" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                        </div>
                        <div class="student-counter">
                            ‡¶Æ‡ßã‡¶ü ‡¶õ‡¶æ‡¶§‡ßç‡¶∞: <span id="student-count">${studentCount}</span>
                        </div>
                    </div>

                    <div class="student-list-container">
                        ${studentCardsHtml}
                    </div>
                </div>
            `;
            
            updateUserUI();

            const searchInput = document.getElementById('student-search-input');
            const studentCountSpan = document.getElementById('student-count');
            const studentListContainer = view.querySelector('.student-list-container');
            const allStudents = studentListContainer.querySelectorAll('.student-card');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                let visibleCount = 0;

                allStudents.forEach(card => {
                    const studentName = card.querySelector('.student-name').textContent.toLowerCase();
                    const fatherName = card.querySelector('.father-name').textContent.toLowerCase();
                    const searchableText = studentName + ' ' + fatherName;

                    if (searchableText.includes(searchTerm)) {
                        card.style.display = 'flex';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });
                studentCountSpan.textContent = visibleCount;
            });

            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => { renderDashboardView(); showView('dashboard-view'); setActiveNav('dashboard-btn'); });

            document.querySelectorAll('.student-card').forEach(card => {
                const studentId = card.dataset.id;
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        renderStudentProfileView(branchId, classId, studentId, className);
                    }
                });

                if (userRole === 'admin') {
                    card.querySelector('.edit-student-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showEditStudentForm(branchId, classId, studentId, className);
                    });
                    card.querySelector('.delete-student-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteStudent(branchId, classId, studentId, className);
                    });
                }
            });

            if (userRole === 'admin') {
                document.getElementById('add-student-btn').addEventListener('click', () => showAddStudentForm(branchId, classId, className));
            }
        }
        
        async function renderStudentProfileView(branchId, classId, studentId, className) {
            const view = document.getElementById('student-view');
            showView('student-view');
            view.innerHTML = `<div class="loader"></div>`;

            const studentDoc = await getDoc(doc(db, `branches/${branchId}/classes/${classId}/students`, studentId));
            if (!studentDoc.exists()) {
                view.innerHTML = `<div class="card"><p>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p></div>`;
                return;
            }
            const student = studentDoc.data();

            let mobileHtml = '';
            if (student.mobile) {
                mobileHtml = `
                    <p style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${student.mobile}
                        <a href="tel:${student.mobile}" class="btn-generic btn-primary btn-sm" style="padding: 3px 12px; font-size: 0.9rem; text-decoration: none;">üìû ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                    </p>
                `;
            }
            
            view.innerHTML = `
                <div class="card" id="student-info-card">
                    <div class="card-header">
                        <h2>${student.name}</h2>
                        <button id="back-to-class-btn" class="btn-generic btn-secondary">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
                    </div>
                    <p>‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ: ${student.fatherName}</p>
                    <p>‡¶Æ‡¶æ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ: ${student.motherName || 'N/A'}</p>
                    <p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ: ${className}</p>
                    ${mobileHtml}
                </div>
                <div class="card">
                    <div class="tabs">
                        <button class="tab-link active" data-tab="finances">‡¶ö‡¶≤‡¶§‡¶ø ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</button>
                        <button class="tab-link" data-tab="results"> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</button>
                        <button class="tab-link admin-only" data-tab="promotion">‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø</button>
                    </div>
                    <div id="finances" class="tab-content active"></div>
                    <div id="results" class="tab-content"></div>
                    <div id="promotion" class="tab-content admin-only"></div>
                </div>
            `;
            updateUserUI();
            
            document.getElementById('back-to-class-btn').addEventListener('click', () => renderClassView(branchId, classId, className));
            
            view.querySelectorAll('.tab-link').forEach(button => {
                button.addEventListener('click', () => {
                    view.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
                    view.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    view.querySelector(`#${button.dataset.tab}`).classList.add('active');
                });
            });

            renderStudentFinances(branchId, classId, studentId);
            renderStudentResults(branchId, classId, studentId);
            if (userRole === 'admin') {
                renderPromotionTab(branchId, classId, studentId, studentDoc.data());
            }
        }
        
        function showAddBranchForm() {
            openModal(`<h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2><input type="text" id="branch-name" placeholder="‡¶∂‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ"><button id="save-branch-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('save-branch-btn').addEventListener('click', async () => {
                const name = document.getElementById('branch-name').value;
                if (!name) return alert('‡¶∂‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
                await addDoc(collection(db, 'branches'), { name });
                modal.style.display = 'none';
                renderDashboardView();
            });
        }
        async function showEditBranchForm(branchId, currentName) {
            openModal(`<h2>‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2><input type="text" id="branch-name" value="${currentName}"><button id="update-branch-btn" class="btn-generic btn-primary">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>`);
            document.getElementById('update-branch-btn').addEventListener('click', async () => {
                const newName = document.getElementById('branch-name').value;
                if (!newName) return alert('‡¶∂‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
                await updateDoc(doc(db, 'branches', branchId), { name: newName });
                modal.style.display = 'none';
                renderDashboardView();
            });
        }
        async function deleteBranch(branchId) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶∂‡¶æ‡¶ñ‡¶æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∏‡¶ï‡¶≤ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶ì ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) {
                await deleteDoc(doc(db, 'branches', branchId));
                alert('‡¶∂‡¶æ‡¶ñ‡¶æ ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§');
                renderDashboardView();
            }
        }
        function showAddClassForm(branchId, branchName) {
            openModal(`<h2>"${branchName}" ‡¶∂‡¶æ‡¶ñ‡¶æ‡¶Ø‡¶º ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2><input type="text" id="class-name" placeholder="‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ"><button id="save-class-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('save-class-btn').addEventListener('click', async () => {
                const name = document.getElementById('class-name').value;
                if (!name) return alert('‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
                await addDoc(collection(db, `branches/${branchId}/classes`), { name });
                modal.style.display = 'none';
                renderDashboardView();
            });
        }
        async function showEditClassForm(branchId, classId, currentName) {
            openModal(`<h2>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2><input type="text" id="class-name" value="${currentName}"><button id="update-class-btn" class="btn-generic btn-primary">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>`);
            document.getElementById('update-class-btn').addEventListener('click', async () => {
                const newName = document.getElementById('class-name').value;
                if (!newName) return alert('‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
                await updateDoc(doc(db, `branches/${branchId}/classes`, classId), { name: newName });
                modal.style.display = 'none';
                renderDashboardView();
            });
        }
        async function deleteClass(branchId, classId) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, `branches/${branchId}/classes`, classId));
                renderDashboardView();
            }
        }
        
        function showAddStudentForm(branchId, classId, className) {
            openModal(`
                <h2>${className} ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶§‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞</h2>
                <input type="text" id="student-name" placeholder="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="text" id="father-name" placeholder="‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="text" id="mother-name" placeholder="‡¶Æ‡¶æ‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="tel" id="student-mobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
                <button id="save-student-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            `);
            document.getElementById('save-student-btn').addEventListener('click', async () => {
                const name = document.getElementById('student-name').value;
                const fatherName = document.getElementById('father-name').value;
                const motherName = document.getElementById('mother-name').value;
                const mobile = document.getElementById('student-mobile').value;
                if (!name || !fatherName) return alert('‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§');
                
                await addDoc(collection(db, `branches/${branchId}/classes/${classId}/students`), { name, fatherName, motherName, mobile, createdAt: serverTimestamp() });
                modal.style.display = 'none';
                renderClassView(branchId, classId, className);
            });
        }
        
        async function showEditStudentForm(branchId, classId, studentId, className) {
            const studentDoc = await getDoc(doc(db, `branches/${branchId}/classes/${classId}/students`, studentId));
            const student = studentDoc.data();
            openModal(`
                <h2>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü</h2>
                <input type="text" id="student-name" value="${student.name}">
                <input type="text" id="father-name" value="${student.fatherName}">
                <input type="text" id="mother-name" value="${student.motherName || ''}">
                <input type="tel" id="student-mobile" value="${student.mobile || ''}">
                <button id="update-student-btn" class="btn-generic btn-primary">‡¶Ü‡¶™‡¶°‡ßá‡¶ü</button>
            `);
            document.getElementById('update-student-btn').addEventListener('click', async () => {
                const name = document.getElementById('student-name').value;
                const fatherName = document.getElementById('father-name').value;
                const motherName = document.getElementById('mother-name').value;
                const mobile = document.getElementById('student-mobile').value;
                if (!name || !fatherName) return alert('‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶™‡¶ø‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§');
                
                await updateDoc(doc(db, `branches/${branchId}/classes/${classId}/students`, studentId), { name, fatherName, motherName, mobile });
                modal.style.display = 'none';
                renderClassView(branchId, classId, className);
            });
        }

        async function deleteStudent(branchId, classId, studentId, className) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, `branches/${branchId}/classes/${classId}/students`, studentId));
                renderClassView(branchId, classId, className);
            }
        }

        async function renderStudentFinances(branchId, classId, studentId) {
            const container = document.getElementById('finances');
            container.innerHTML = `<div class="loader"></div>`;
            const financesPath = `branches/${branchId}/classes/${classId}/students/${studentId}/finances`;
            const financesSnapshot = await getDocs(query(collection(db, financesPath), orderBy('date', 'desc')));
            
            let totalDue = 0, totalPaid = 0, tableRows = '';
            financesSnapshot.forEach(doc => {
                const item = doc.data();
                const amount = Number(item.amount);
                if (item.type === '‡¶™‡¶æ‡¶ì‡¶®‡¶æ') totalDue += amount;
                else totalPaid += amount;
                tableRows += `<tr data-id="${doc.id}">
                    <td>${item.type}</td>
                    <td>${item.details}</td>
                    <td>${amount.toLocaleString('bn-BD')} ‡ß≥</td>
                    <td>${new Date(item.date.seconds * 1000).toLocaleDateString('bn-BD')}</td>
                    <td class="admin-only">
                        <button class="btn-generic btn-danger btn-sm delete-finance-btn">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
                    </td>
                </tr>`;
            });

            container.innerHTML = `
                <div class="card-header"><h3>‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h3><div class="admin-only"><button id="add-finance-btn" class="btn-generic btn-primary btn-sm">‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</button></div></div>
                <div class="funds-summary">
                    <div class="card summary-card expense"><h4>‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡¶®‡¶æ</h4><h5>${totalDue.toLocaleString('bn-BD')} ‡ß≥</h5></div>
                    <div class="card summary-card income"><h4>‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</h4><h5>${totalPaid.toLocaleString('bn-BD')} ‡ß≥</h5></div>
                    <div class="card summary-card balance"><h4>‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü</h4><h5>${(totalDue - totalPaid).toLocaleString('bn-BD')} ‡ß≥</h5></div>
                </div>
                <div class="table-responsive-wrapper">
                    <table class="professional-table">
                        <thead><tr><th>‡¶ß‡¶∞‡¶®</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶ü‡¶æ‡¶ï‡¶æ</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th class="admin-only">‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead>
                        <tbody>${tableRows || '<tr><td colspan="5">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§</td></tr>'}</tbody>
                    </table>
                </div>
            `;
            updateUserUI();
            if(userRole === 'admin') {
                document.getElementById('add-finance-btn').addEventListener('click', () => showAddFinanceForm(branchId, classId, studentId));
                container.querySelectorAll('.delete-finance-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const financeId = e.target.closest('tr').dataset.id;
                        deleteFinance(branchId, classId, studentId, financeId);
                    });
                });
            }
        }
        function showAddFinanceForm(branchId, classId, studentId) {
            openModal(`<h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h2><select id="finance-type"><option value="‡¶™‡¶æ‡¶ì‡¶®‡¶æ">‡¶™‡¶æ‡¶ì‡¶®‡¶æ</option><option value="‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß">‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß</option></select><input type="text" id="finance-details" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßá‡¶§‡¶®)"><input type="number" id="finance-amount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£"><input type="date" id="finance-date"><button id="save-finance-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('finance-date').valueAsDate = new Date();
            document.getElementById('save-finance-btn').addEventListener('click', async () => {
                const type = document.getElementById('finance-type').value;
                const details = document.getElementById('finance-details').value;
                const amount = document.getElementById('finance-amount').value;
                const date = document.getElementById('finance-date').value;
                if (!details || !amount || !date) return alert('‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                const financesPath = `branches/${branchId}/classes/${classId}/students/${studentId}/finances`;
                await addDoc(collection(db, financesPath), { type, details, amount: Number(amount), date: new Date(date) });
                modal.style.display = 'none';
                renderStudentFinances(branchId, classId, studentId);
            });
        }
        async function deleteFinance(branchId, classId, studentId, financeId) {
            if (confirm('‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                const financePath = `branches/${branchId}/classes/${classId}/students/${studentId}/finances`;
                await deleteDoc(doc(db, financePath, financeId));
                renderStudentFinances(branchId, classId, studentId);
            }
        }
        
        function calculateGrade(totalMarks, marksObject) {
            if (!gradingSettings) {
                console.error("Grading settings not loaded!");
                return 'N/A'; 
            }
            for (const subject in marksObject) {
                if (marksObject[subject] < gradingSettings.passMark) return 'F';
            }
            const grades = gradingSettings.grades;
            if (totalMarks >= grades['A+']) return 'A+';
            if (totalMarks >= grades['A']) return 'A';
            if (totalMarks >= grades['A-']) return 'A-';
            if (totalMarks >= grades['B']) return 'B';
            if (totalMarks >= grades['C']) return 'C';
            if (totalMarks >= grades['D']) return 'D';
            return 'F';
        }
        
        async function renderStudentResults(branchId, classId, studentId) {
            const container = document.getElementById('results');
            container.innerHTML = `<div class="loader"></div>`;
            const resultsPath = `branches/${branchId}/classes/${classId}/students/${studentId}/results`;
            const resultsSnapshot = await getDocs(collection(db, resultsPath));

            let resultsHtml = `
                <div class="card-header">
                    <h3>‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h3>
                    <div>
                        <button id="download-pdf-btn" class="btn-generic btn-secondary btn-sm">PDF</button>
                        <span class="admin-only">
                           <button id="add-result-btn" class="btn-generic btn-primary btn-sm">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Ø‡ßã‡¶ó/‡¶è‡¶°‡¶ø‡¶ü</button>
                        </span>
                    </div>
                </div>`;

            if (resultsSnapshot.empty) { 
                resultsHtml += '<p>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>'; 
            } else {
                resultsSnapshot.forEach(doc => {
                    const termResult = doc.data();
                    let totalMarks = 0, tableRows = '', marksObject = termResult.marks || {};
                    for (const subject in marksObject) {
                        const mark = marksObject[subject];
                        totalMarks += Number(mark);
                        tableRows += `<tr><td>${subject}</td><td>${mark}</td></tr>`;
                    }
                    const grade = calculateGrade(totalMarks, marksObject);
                    resultsHtml += `<div class="card result-term-card" data-term-id="${doc.id}"><h4>${doc.id.replace(/_/g, ' ')}</h4><table><thead><tr><th>‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</th><th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th></tr></thead><tbody>${tableRows}</tbody></table><h4 style="text-align:right; margin-top:10px;">‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: ${totalMarks} | ‡¶ó‡ßç‡¶∞‡ßá‡¶°: <span style="color: ${grade === 'F' ? 'red' : 'green'};">${grade}</span></h4></div>`;
                });
            }
            container.innerHTML = resultsHtml;
            updateUserUI();

            document.getElementById('download-pdf-btn').addEventListener('click', () => showTermSelectionForPdf());

            if(userRole === 'admin') {
                document.getElementById('add-result-btn').addEventListener('click', () => showAddResultForm(branchId, classId, studentId));
            }
        }

        async function showTermSelectionForPdf() {
            openModal(`
                <h2>‡¶ï‡ßã‡¶® ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</h2>
                <select id="pdf-term-select">
                    <option value="‡ßß‡¶Æ_‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï">‡ßß‡¶Æ ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï</option>
                    <option value="‡ß®‡¶Ø‡¶º_‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï">‡ß®‡¶Ø‡¶º ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï</option>
                    <option value="‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï</option>
                </select>
                <button id="confirm-pdf-download-btn" class="btn-generic btn-primary">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            `);

            document.getElementById('confirm-pdf-download-btn').addEventListener('click', async () => {
                modalBody.innerHTML = `<div class="loader"></div><p style="text-align:center;">PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>`;
                
                const selectedTermId = document.getElementById('pdf-term-select').value;
                const studentInfoCard = document.getElementById('student-info-card');
                
                const studentName = studentInfoCard.querySelector('h2').textContent;
                const fatherName = studentInfoCard.querySelector('p:nth-of-type(1)').textContent;
                const className = studentInfoCard.querySelector('p:nth-of-type(3)').textContent;

                const selectedResultCard = document.querySelector(`.result-term-card[data-term-id="${selectedTermId}"]`);
                if (!selectedResultCard) {
                    alert('‡¶è‡¶á ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï‡ßá‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                    modal.style.display = 'none';
                    return;
                }
                
                const marks = {};
                selectedResultCard.querySelectorAll('tbody tr').forEach(row => {
                    marks[row.cells[0].textContent] = Number(row.cells[1].textContent);
                });

                const summaryText = selectedResultCard.querySelector('h4[style*="text-align:right"]').textContent;
                const totalMarks = summaryText.match(/‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: (\d+)/)[1];
                const grade = summaryText.match(/‡¶ó‡ßç‡¶∞‡ßá‡¶°: (.+)/)[1].trim();

                try {
                    await generateProfessionalPDF(studentName, fatherName, className, selectedTermId, marks, totalMarks, grade);
                } catch (error) {
                    console.error("PDF generation failed:", error);
                    alert("PDF ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                } finally {
                    modal.style.display = 'none';
                }
            });
        }
        
        async function generateProfessionalPDF(studentName, fatherName, className, term, marks, totalMarks, grade) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            const fontUrl = 'fonts/TiroBangla.ttf';
            const fontResponse = await fetch(fontUrl);
            const fontBlob = await fontResponse.arrayBuffer();
            const fontBase64 = btoa(new Uint8Array(fontBlob).reduce((data, byte) => data + String.fromCharCode(byte), ''));

            pdf.addFileToVFS('TiroBangla.ttf', fontBase64);
            pdf.addFont('TiroBangla.ttf', 'TiroBangla', 'normal');
            pdf.setFont('TiroBangla');

            const pageWidth = pdf.internal.pageSize.getWidth();
            let y = 20;

            pdf.setFontSize(22);
            pdf.text('‡¶á‡¶ï‡¶∞‡¶æ ‡¶Æ‡¶æ‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡¶æ', pageWidth / 2, y, { align: 'center' });
            y += 8;
            pdf.setFontSize(12);
            pdf.text('‡¶¨‡ßá‡¶ó‡¶Æ‡¶™‡ßÅ‡¶∞, ‡¶Æ‡¶π‡ßá‡¶∂‡¶™‡ßÅ‡¶∞, ‡¶ù‡¶ø‡¶®‡¶æ‡¶á‡¶¶‡¶π', pageWidth / 2, y, { align: 'center' });
            y += 12;
            pdf.setFontSize(16);
            pdf.text('‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤', pageWidth / 2, y, { align: 'center' });
            y += 5;
            pdf.setLineWidth(0.5);
            pdf.line(20, y, pageWidth - 20, y);
            y += 15;
            pdf.setFontSize(12);
            pdf.text(`‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ: ${studentName}`, 20, y); y += 8;
            pdf.text(`${fatherName}`, 20, y); y += 8;
            pdf.text(`${className}`, 20, y); y += 8;
            pdf.text(`‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ: ${term.replace(/_/g, ' ')}`, 20, y); y += 15;

            const tableX = 20, col1X = tableX + 5, col2X = tableX + 130;
            pdf.setFontSize(14);
            pdf.text('‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º', col1X, y);
            pdf.text('‡¶®‡¶Æ‡ßç‡¶¨‡¶∞', col2X, y);
            y += 3;
            pdf.setLineWidth(0.3);
            pdf.line(tableX, y, pageWidth - tableX, y); y += 8;
            
            pdf.setFontSize(12);
            for (const subject in marks) {
                pdf.text(subject, col1X, y);
                pdf.text(String(marks[subject]), col2X, y);
                y += 8;
            }
            pdf.line(tableX, y, pageWidth - tableX, y); y += 8;
            
            pdf.setFontSize(14);
            pdf.text('‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:', col1X, y);
            pdf.text(String(totalMarks), col2X, y); y += 8;
            pdf.text('‡¶ó‡ßç‡¶∞‡ßá‡¶°:', col1X, y);
            pdf.text(grade, col2X, y);
            
            pdf.save(`${studentName}_${term}_result.pdf`);
        }

        async function showAddResultForm(branchId, classId, studentId) {
            const resultsPath = `branches/${branchId}/classes/${classId}/students/${studentId}/results`;
            let formHtml = `<h2>‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Ø‡ßã‡¶ó/‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2><select id="term-select"><option value="‡ßß‡¶Æ_‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï">‡ßß‡¶Æ ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï</option><option value="‡ß®‡¶Ø‡¶º_‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï">‡ß®‡¶Ø‡¶º ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï</option><option value="‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï</option></select><div id="subjects-container"></div><button id="add-subject-btn" class="btn-generic btn-secondary">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º ‡¶Ø‡ßã‡¶ó</button><hr style="margin: 1rem 0;"><button id="save-result-btn" class="btn-generic btn-primary">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
            openModal(formHtml);
            const termSelect = document.getElementById('term-select');
            const subjectsContainer = document.getElementById('subjects-container');
            const loadTermData = async () => {
                subjectsContainer.innerHTML = '';
                const term = termSelect.value;
                const resultDoc = await getDoc(doc(db, resultsPath, term));
                const marks = resultDoc.exists() ? resultDoc.data().marks : {};
                if (Object.keys(marks).length === 0) { addSubjectRow(); }
                else { for (const subject in marks) { addSubjectRow(subject, marks[subject]); } }
            };
            const addSubjectRow = (subject = '', mark = '') => {
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.gap = '10px';
                row.innerHTML = `<input type="text" class="subject-name" placeholder="‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" value="${subject}"><input type="number" class="subject-mark" placeholder="‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" value="${mark}">`;
                subjectsContainer.appendChild(row);
            };
            document.getElementById('add-subject-btn').addEventListener('click', () => addSubjectRow());
            termSelect.addEventListener('change', loadTermData);
            document.getElementById('save-result-btn').addEventListener('click', async () => {
                const term = termSelect.value;
                const marks = {};
                subjectsContainer.querySelectorAll('div').forEach(row => {
                    const subject = row.querySelector('.subject-name').value;
                    const mark = row.querySelector('.subject-mark').value;
                    if (subject && mark) { marks[subject] = Number(mark); }
                });
                await setDoc(doc(db, resultsPath, term), { marks });
                modal.style.display = 'none';
                renderStudentResults(branchId, classId, studentId);
            });
            loadTermData();
        }
        async function renderPromotionTab(currentBranchId, currentClassId, studentId, studentData) {
            const container = document.getElementById('promotion');
            container.innerHTML = `<div class="loader"></div>`;
            const branchesSnapshot = await getDocs(collection(db, 'branches'));
            let optionsHtml = '';
            for (const branchDoc of branchesSnapshot.docs) {
                optionsHtml += `<optgroup label="${branchDoc.data().name}">`;
                const classesSnapshot = await getDocs(collection(db, `branches/${branchDoc.id}/classes`));
                classesSnapshot.forEach(classDoc => {
                    if (classDoc.id !== currentClassId) { optionsHtml += `<option value="${branchDoc.id}/${classDoc.id}">${classDoc.data().name}</option>`; }
                });
                optionsHtml += `</optgroup>`;
            }
            container.innerHTML = `<h3>‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø</h3><p>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶§‡ßá ‡¶â‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p><select id="promotion-class-select">${optionsHtml}</select><button id="promote-student-btn" class="btn-generic btn-primary">‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø ‡¶¶‡¶ø‡¶®</button>`;
            document.getElementById('promote-student-btn').addEventListener('click', async () => {
                const selected = document.getElementById('promotion-class-select').value;
                if (!selected) return alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ‡¶§‡ßá ‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) return;
                const [newBranchId, newClassId] = selected.split('/');
                const batch = writeBatch(db);
                const newStudentRef = doc(collection(db, `branches/${newBranchId}/classes/${newClassId}/students`));
                batch.set(newStudentRef, studentData);
                const oldStudentRef = doc(db, `branches/${currentBranchId}/classes/${currentClassId}/students/${studentId}`);
                batch.delete(oldStudentRef);
                await batch.commit();
                alert('‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶ï‡ßá ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶¶‡ßã‡¶®‡ßç‡¶®‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
                renderDashboardView();
                showView('dashboard-view');
                setActiveNav('dashboard-btn');
            });
        }
        
        async function renderFundsView() {
            const view = document.getElementById('funds-view');
            view.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h2>
                    </div>
                    <div class="tabs">
                        <button class="tab-link active" data-tab="general-funds">‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</button>
                        <button class="tab-link" data-tab="teacher-salaries">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶®</button>
                    </div>
                    <div id="general-funds" class="tab-content active"></div>
                    <div id="teacher-salaries" class="tab-content"></div>
                </div>
            `;
            
            view.querySelectorAll('.tab-link').forEach(button => {
                button.addEventListener('click', () => {
                    view.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
                    view.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    view.querySelector(`#${button.dataset.tab}`).classList.add('active');
                });
            });

            renderGeneralFunds();
            renderTeacherSalaries();
        }

        async function getStudentLedger() {
            const studentTransactions = [];
            let totalStudentIncome = 0;
            let totalStudentDues = 0;

            const branchesSnapshot = await getDocs(collection(db, 'branches'));
            for (const branchDoc of branchesSnapshot.docs) {
                const classesSnapshot = await getDocs(collection(db, `branches/${branchDoc.id}/classes`));
                for (const classDoc of classesSnapshot.docs) {
                    const studentsSnapshot = await getDocs(collection(db, `branches/${branchDoc.id}/classes/${classDoc.id}/students`));
                    for (const studentDoc of studentsSnapshot.docs) {
                        const financesSnapshot = await getDocs(collection(db, `branches/${branchDoc.id}/classes/${classDoc.id}/students/${studentDoc.id}/finances`));
                        let studentDue = 0;
                        let studentPaid = 0;
                        financesSnapshot.forEach(financeDoc => {
                            const finance = financeDoc.data();
                            const amount = Number(finance.amount);
                            if (finance.type === '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß') {
                                totalStudentIncome += amount;
                                studentPaid += amount;
                                studentTransactions.push({
                                    type: '‡¶Ü‡¶Ø‡¶º (‡¶õ‡¶æ‡¶§‡ßç‡¶∞)',
                                    details: `${studentDoc.data().name} - ${finance.details}`,
                                    amount: amount,
                                    date: finance.date
                                });
                            } else if (finance.type === '‡¶™‡¶æ‡¶ì‡¶®‡¶æ') {
                                studentDue += amount;
                            }
                        });
                         totalStudentDues += (studentDue - studentPaid);
                    }
                }
            }
            return { studentTransactions, totalStudentIncome, totalStudentDues };
        }

        async function renderGeneralFunds() {
            const container = document.getElementById('general-funds');
            container.innerHTML = `<div class="loader"></div>`;
            try {
                const { studentTransactions, totalStudentIncome, totalStudentDues } = await getStudentLedger();
                const fundsSnapshot = await getDocs(query(collection(db, 'funds'), orderBy('date', 'desc')));
                
                let generalIncome = 0;
                let generalExpense = 0;
                const generalTransactions = [];

                fundsSnapshot.forEach(doc => {
                    const fund = doc.data();
                    const amount = Number(fund.amount);
                    if (fund.type === '‡¶Ü‡¶Ø‡¶º') {
                        generalIncome += amount;
                    } else { 
                        generalExpense += amount;
                    }
                    generalTransactions.push({ ...fund, id: doc.id, date: fund.date });
                });

                const totalIncome = generalIncome + totalStudentIncome;
                const totalExpense = generalExpense;
                const balance = totalIncome - totalExpense;

                const allTransactions = [...generalTransactions, ...studentTransactions].sort((a, b) => b.date.seconds - a.date.seconds);

                let tableRows = '';
                allTransactions.forEach(trans => {
                    const isGeneralFund = 'id' in trans;
                    tableRows += `
                        <tr data-id="${isGeneralFund ? trans.id : ''}">
                            <td>${trans.type}</td>
                            <td>${trans.details}</td>
                            <td>${Number(trans.amount).toLocaleString('bn-BD')} ‡ß≥</td>
                            <td>${new Date(trans.date.seconds * 1000).toLocaleDateString('bn-BD')}</td>
                            <td>
                                ${isGeneralFund ? `
                                <button class="btn-generic btn-secondary btn-sm edit-fund-btn">‡¶è‡¶°‡¶ø‡¶ü</button>
                                <button class="btn-generic btn-danger btn-sm delete-fund-btn">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
                                ` : '‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá'}
                            </td>
                        </tr>`;
                });

                container.innerHTML = `
                    <div class="card-header" style="margin-top: 20px;">
                        <h3>‡¶∏‡¶æ‡¶∞‡ßç‡¶¨‡¶ø‡¶ï ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</h3>
                        <button id="add-fund-btn" class="btn-generic btn-primary">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</button>
                    </div>
                    <div class="funds-summary">
                        <div class="card summary-card income"><h4>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶Ø‡¶º</h4><h2>${totalIncome.toLocaleString('bn-BD')} ‡ß≥</h2></div>
                        <div class="card summary-card expense"><h4>‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º</h4><h2>${totalExpense.toLocaleString('bn-BD')} ‡ß≥</h2></div>
                        <div class="card summary-card balance"><h4>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h4><h2>${balance.toLocaleString('bn-BD')} ‡ß≥</h2></div>
                        <div class="card summary-card dues"><h4>‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</h4><h2>${totalStudentDues.toLocaleString('bn-BD')} ‡ß≥</h2></div>
                    </div>
                    <div class="card">
                        <h3>‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                        <div class="table-responsive-wrapper">
                            <table class="professional-table">
                                <thead><tr><th>‡¶ß‡¶∞‡¶®</th><th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead>
                                <tbody>${tableRows || '<tr><td colspan="5">‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>`;

                document.getElementById('add-fund-btn').addEventListener('click', showAddFundForm);
                container.querySelectorAll('.edit-fund-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const docId = e.target.closest('tr').dataset.id;
                    if(docId) showEditFundForm(docId);
                }));
                container.querySelectorAll('.delete-fund-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const docId = e.target.closest('tr').dataset.id;
                    if(docId) deleteFund(docId);
                }));

            } catch (error) {
                console.error("Error rendering general funds:", error);
                container.innerHTML = `<div class="card"><p>‡¶§‡¶π‡¶¨‡¶ø‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§</p></div>`;
            }
        }

        function showAddFundForm() {
            openModal(`
                <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h2>
                <select id="fund-type"><option value="‡¶Ü‡¶Ø‡¶º">‡¶Ü‡¶Ø‡¶º</option><option value="‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º">‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option></select>
                <input type="text" id="fund-details" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£">
                <input type="number" id="fund-amount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                <input type="date" id="fund-date">
                <button id="save-fund-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('fund-date').valueAsDate = new Date();
            document.getElementById('save-fund-btn').addEventListener('click', async () => {
                const type = document.getElementById('fund-type').value;
                const details = document.getElementById('fund-details').value;
                const amount = document.getElementById('fund-amount').value;
                const date = document.getElementById('fund-date').value;
                if (!details || !amount || !date) return alert('‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                await addDoc(collection(db, 'funds'), { type, details, amount: Number(amount), date: new Date(date) });
                modal.style.display = 'none';
                renderGeneralFunds();
            });
        }

        async function showEditFundForm(docId) {
            const docRef = doc(db, 'funds', docId);
            const fundDoc = await getDoc(docRef);
            const fund = fundDoc.data();
            const date = new Date(fund.date.seconds * 1000).toISOString().split('T')[0];

            openModal(`
                <h2>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <select id="fund-type">
                    <option value="‡¶Ü‡¶Ø‡¶º" ${fund.type === '‡¶Ü‡¶Ø‡¶º' ? 'selected' : ''}>‡¶Ü‡¶Ø‡¶º</option>
                    <option value="‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º" ${fund.type === '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º' ? 'selected' : ''}>‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º</option>
                </select>
                <input type="text" id="fund-details" value="${fund.details}">
                <input type="number" id="fund-amount" value="${fund.amount}">
                <input type="date" id="fund-date" value="${date}">
                <button id="update-fund-btn" class="btn-generic btn-primary">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            
            document.getElementById('update-fund-btn').addEventListener('click', async () => {
                const type = document.getElementById('fund-type').value;
                const details = document.getElementById('fund-details').value;
                const amount = document.getElementById('fund-amount').value;
                const date = document.getElementById('fund-date').value;
                if (!details || !amount || !date) return alert('‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                await updateDoc(docRef, { type, details, amount: Number(amount), date: new Date(date) });
                modal.style.display = 'none';
                renderGeneralFunds();
            });
        }

        async function deleteFund(docId) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, 'funds', docId));
                renderGeneralFunds();
            }
        }

        async function renderTeacherSalaries() {
            const container = document.getElementById('teacher-salaries');
            container.innerHTML = `<div class="loader"></div>`;
            try {
                const teachersSnapshot = await getDocs(collection(db, 'teachers'));
                let tableRows = '';
                teachersSnapshot.forEach(doc => {
                    const teacher = doc.data();
                    tableRows += `
                        <tr data-id="${doc.id}" data-name="${teacher.name}">
                            <td>${teacher.name}</td>
                            <td>${teacher.designation || 'N/A'}</td>
                            <td>
                                <button class="btn-generic btn-primary btn-sm give-salary-btn">‡¶¨‡ßá‡¶§‡¶® ‡¶¶‡¶ø‡¶®</button>
                                <button class="btn-generic btn-secondary btn-sm salary-history-btn">‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</button>
                                <button class="btn-generic btn-danger btn-sm delete-teacher-btn">‡¶°‡¶ø‡¶≤‡ßá‡¶ü</button>
                            </td>
                        </tr>`;
                });

                container.innerHTML = `
                    <div class="card-header" style="margin-top: 20px;">
                        <h3>‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h3>
                        <button id="add-teacher-btn" class="btn-generic btn-primary">‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï</button>
                    </div>
                    <div class="card">
                       <div class="table-responsive-wrapper">
                            <table class="professional-table">
                                <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶™‡¶¶‡¶¨‡¶ø</th><th>‡¶è‡¶ï‡¶∂‡¶®</th></tr></thead>
                                <tbody>${tableRows || '<tr><td colspan="3">‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>'}</tbody>
                            </table>
                        </div>
                    </div>`;

                document.getElementById('add-teacher-btn').addEventListener('click', showAddTeacherForm);
                container.querySelectorAll('.give-salary-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    showAddSalaryForm(row.dataset.id, row.dataset.name);
                }));
                 container.querySelectorAll('.salary-history-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    renderSalaryHistory(row.dataset.id, row.dataset.name);
                }));
                container.querySelectorAll('.delete-teacher-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    deleteTeacher(row.dataset.id);
                }));

            } catch (error) {
                console.error("Error rendering teacher salaries:", error);
                container.innerHTML = `<div class="card"><p>‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p></div>`;
            }
        }
        
        function showAddTeacherForm() {
             openModal(`
                <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <input type="text" id="teacher-name" placeholder="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="text" id="teacher-designation" placeholder="‡¶™‡¶¶‡¶¨‡¶ø">
                <button id="save-teacher-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('save-teacher-btn').addEventListener('click', async () => {
                const name = document.getElementById('teacher-name').value;
                const designation = document.getElementById('teacher-designation').value;
                if (!name) return alert('‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§');
                await addDoc(collection(db, 'teachers'), { name, designation });
                modal.style.display = 'none';
                renderTeacherSalaries();
            });
        }

        async function deleteTeacher(teacherId) {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, 'teachers', teacherId));
                renderTeacherSalaries();
            }
        }
        
        function showAddSalaryForm(teacherId, teacherName) {
            openModal(`
                <h2>${teacherName} ‡¶ï‡ßá ‡¶¨‡ßá‡¶§‡¶® ‡¶¶‡¶ø‡¶®</h2>
                <input type="number" id="salary-amount" placeholder="‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                <input type="text" id="salary-month" placeholder="‡¶ï‡ßã‡¶® ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø ‡ß®‡ß¶‡ß®‡ß´)">
                <input type="date" id="salary-date">
                <button id="save-salary-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('salary-date').valueAsDate = new Date();
            document.getElementById('save-salary-btn').addEventListener('click', async () => {
                const amount = document.getElementById('salary-amount').value;
                const month = document.getElementById('salary-month').value;
                const date = document.getElementById('salary-date').value;
                if (!amount || !month || !date) return alert('‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');

                await addDoc(collection(db, `teachers/${teacherId}/salaries`), { 
                    amount: Number(amount), month, date: new Date(date), teacherId, teacherName
                });
                await addDoc(collection(db, 'funds'), {
                    type: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º', details: `${teacherName} ‡¶ï‡ßá ${month} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡ßá‡¶§‡¶® ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®`,
                    amount: Number(amount), date: new Date(date)
                });
                modal.style.display = 'none';
                alert('‡¶¨‡ßá‡¶§‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
                renderGeneralFunds();
            });
        }

        async function renderSalaryHistory(teacherId, teacherName) {
            const salaryHistorySnapshot = await getDocs(query(collection(db, `teachers/${teacherId}/salaries`), orderBy('date', 'desc')));
            let tableRows = '';
            let totalPaid = 0;
            salaryHistorySnapshot.forEach(doc => {
                const salary = doc.data();
                totalPaid += Number(salary.amount);
                tableRows += `
                    <tr>
                        <td>${salary.month}</td>
                        <td>${Number(salary.amount).toLocaleString('bn-BD')} ‡ß≥</td>
                        <td>${new Date(salary.date.seconds * 1000).toLocaleDateString('bn-BD')}</td>
                    </tr>`;
            });

            openModal(`
                <h2>${teacherName} ‡¶è‡¶∞ ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h2>
                <h4>‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${totalPaid.toLocaleString('bn-BD')} ‡ß≥</h4>
                <div class="table-responsive-wrapper">
                    <table class="professional-table">
                        <thead><tr><th>‡¶Æ‡¶æ‡¶∏</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th></tr></thead>
                        <tbody>${tableRows || '<tr><td colspan="3">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßá‡¶§‡¶®‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</td></tr>'}</tbody>
                    </table>
                </div>`);
        }

        async function renderNoticeBoard() {
            const view = document.getElementById('notice-view');
            view.innerHTML = `<div class="loader"></div>`;
            try {
                const q = query(collection(db, 'notices'), orderBy('createdAt', 'desc'));
                const noticeSnapshot = await getDocs(q);
                let html = `<div class="card">
                                <div class="card-header centered-card-header"><h2>‡¶®‡ßã‡¶ü‡¶ø‡¶∏ ‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2><div class="admin-only"><button id="add-notice-btn" class="btn-generic btn-primary">‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶∏</button></div></div>
                                <div id="contact-info-section"><div class="loader"></div></div>
                            </div>
                            <div id="latest-notice"></div>
                            <h3>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶®‡ßã‡¶ü‡¶ø‡¶∏‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
                            <div id="old-notices-grid"></div>`;
                view.innerHTML = html;

                renderContactInfo();

                updateUserUI();
                const notices = noticeSnapshot.docs;
                if (notices.length > 0) {
                    const latest = notices[0].data();
                    document.getElementById('latest-notice').innerHTML = `<div class="card" id="latest-notice-card"><h3>${latest.title}</h3><p>${latest.details.replace(/\n/g, '<br>')}</p><small>‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§: ${new Date(latest.createdAt.seconds * 1000).toLocaleDateString('bn-BD')}</small></div>`;
                } else {
                     document.getElementById('latest-notice').innerHTML = "<p>‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã‡¶ü‡¶ø‡¶∏ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>";
                }
                const oldNoticesGrid = document.getElementById('old-notices-grid');
                oldNoticesGrid.innerHTML = '';
                notices.slice(1).forEach(doc => {
                    const notice = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card old-notice-card';
                    card.innerHTML = `<h4>${notice.title}</h4><small>${new Date(notice.createdAt.seconds * 1000).toLocaleDateString('bn-BD')}</small>`;
                    card.onclick = () => openModal(`<h2>${notice.title}</h2><p>${notice.details.replace(/\n/g, '<br>')}</p>`);
                    oldNoticesGrid.appendChild(card);
                });
                if (userRole === 'admin') {
                    document.getElementById('add-notice-btn').addEventListener('click', showAddNoticeForm);
                }
            } catch (error) {
                view.innerHTML = `<div class="card"><p>‡¶®‡ßã‡¶ü‡¶ø‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§</p></div>`;
            }
        }
        
        async function renderContactInfo() {
            const container = document.getElementById('contact-info-section');
            try {
                const contactDoc = await getDoc(doc(db, 'settings', 'contact'));
                if (contactDoc.exists()) {
                    const data = contactDoc.data();
                    const title = data.title || '‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
                    const contacts = Array.isArray(data.contacts) ? data.contacts : [];

                    let contactsHtml = '';
                    if (contacts.length > 0) {
                        contacts.forEach(contact => {
                            contactsHtml += `
                                <li>
                                    <span class="contact-details">${contact.name}: <strong>${contact.mobile}</strong></span>
                                    <a href="tel:${contact.mobile}" class="btn-generic btn-primary btn-sm" style="text-decoration: none;">üìû ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</a>
                                </li>`;
                        });
                    }
                    
                    container.innerHTML = `
                        <h4 class="contact-title">${title}</h4>
                        <ul class="contact-list">${contactsHtml}</ul>
                    `;

                    if (userRole === 'admin') {
                        const adminControls = document.createElement('div');
                        adminControls.className = 'contact-admin-controls';
                        adminControls.innerHTML = `<button id="edit-contact-btn" class="btn-generic btn-secondary btn-sm">‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                        container.appendChild(adminControls);
                        document.getElementById('edit-contact-btn').addEventListener('click', () => showContactForm(data));
                    }

                } else {
                    if (userRole === 'admin') {
                        container.innerHTML = `<p>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p><button id="add-contact-btn" class="btn-generic btn-primary btn-sm">‡¶§‡¶•‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                        document.getElementById('add-contact-btn').addEventListener('click', () => showContactForm());
                    } else {
                        container.innerHTML = '';
                        container.style.display = 'none';
                    }
                }
            } catch(e) {
                console.error("Failed to load contact info:", e);
                container.innerHTML = '<p>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
            }
        }

        function showContactForm(data = {}) {
            const defaultTitle = '‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®';
            let contacts = Array.isArray(data.contacts) ? data.contacts : [];

            // ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡¶æ‡¶á‡¶ó‡ßç‡¶∞‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            if (contacts.length === 0 && data.name && data.mobile) {
                contacts.push({ name: data.name, mobile: data.mobile });
            }

            let contactsHtml = '';
            contacts.forEach((contact, index) => {
                contactsHtml += `
                    <div class="contact-entry" style="display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                        <input type="text" class="contact-name-input" placeholder="‡¶®‡¶æ‡¶Æ" value="${contact.name || ''}" style="flex: 1;">
                        <input type="tel" class="contact-mobile-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" value="${contact.mobile || ''}" style="flex: 2;">
                        <button class="btn-generic btn-danger btn-sm remove-contact-btn">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                    </div>`;
            });
            
            openModal(`
                <h2>‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <div class="form-group">
                    <label>‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
                    <input type="text" id="contact-title-input" value="${data.title || defaultTitle}">
                </div>
                <div id="contact-entries-container">${contactsHtml}</div>
                <button id="add-more-contact-btn" class="btn-generic btn-secondary" style="margin-bottom: 20px;">‡¶Ü‡¶∞‡¶ì ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <hr>
                <button id="save-contact-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            `);

            const container = document.getElementById('contact-entries-container');

            const addContactRow = (contact = {}) => {
                const div = document.createElement('div');
                div.className = 'contact-entry';
                div.style = "display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;";
                div.innerHTML = `
                    <input type="text" class="contact-name-input" placeholder="‡¶®‡¶æ‡¶Æ" value="${contact.name || ''}" style="flex: 1;">
                    <input type="tel" class="contact-mobile-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" value="${contact.mobile || ''}" style="flex: 2;">
                    <button class="btn-generic btn-danger btn-sm remove-contact-btn">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                `;
                container.appendChild(div);
            };
            
            document.getElementById('add-more-contact-btn').addEventListener('click', () => addContactRow());
            
            modalBody.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('remove-contact-btn')) {
                    e.target.closest('.contact-entry').remove();
                }
            });

            document.getElementById('save-contact-btn').addEventListener('click', async () => {
                const title = document.getElementById('contact-title-input').value;
                const contactsArray = [];
                document.querySelectorAll('.contact-entry').forEach(entry => {
                    const name = entry.querySelector('.contact-name-input').value.trim();
                    const mobile = entry.querySelector('.contact-mobile-input').value.trim();
                    if (name && mobile) {
                        contactsArray.push({ name, mobile });
                    }
                });

                await setDoc(doc(db, "settings", "contact"), { title, contacts: contactsArray });
                modal.style.display = 'none';
                renderContactInfo();
            });
        }
        function showAddNoticeForm() {
            openModal(`<h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡ßã‡¶ü‡¶ø‡¶∏</h2><input type="text" id="notice-title" placeholder="‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ"><textarea id="notice-details" rows="5" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§"></textarea><button id="save-notice-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>`);
            document.getElementById('save-notice-btn').addEventListener('click', async () => {
                const title = document.getElementById('notice-title').value;
                const details = document.getElementById('notice-details').value;
                if (!title || !details) return alert('‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§');
                await addDoc(collection(db, 'notices'), { title, details, createdAt: serverTimestamp() });
                modal.style.display = 'none';
                renderNoticeBoard();
            });
        }
        
        async function renderSettingsView() {
            const view = document.getElementById('settings-view');
            view.innerHTML = `<div class="loader"></div>`;

            if (!gradingSettings) await loadGradingSettings();

            let gradeInputsHtml = '';
            const gradeOrder = ['A+', 'A', 'A-', 'B', 'C', 'D'];
            gradeOrder.forEach(grade => {
                gradeInputsHtml += `
                    <div class="form-group">
                        <label for="grade-${grade}">‡¶ó‡ßç‡¶∞‡ßá‡¶° ${grade} (‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶Æ‡ßã‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞)</label>
                        <input type="number" id="grade-${grade}" value="${gradingSettings.grades[grade] || 0}">
                    </div>
                `;
            });

            view.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>‡¶ó‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
                    </div>
                    <div id="settings-form" style="padding: 10px;">
                        <div class="form-group">
                            <label for="pass-mark">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡¶æ‡¶∏ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
                            <input type="number" id="pass-mark" value="${gradingSettings.passMark || 40}">
                        </div>
                        <hr style="margin: 2rem 0;">
                        <h3>‡¶ó‡ßç‡¶∞‡ßá‡¶° ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                        ${gradeInputsHtml}
                        <button id="save-settings-btn" class="btn-generic btn-primary">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <p id="settings-success-msg" style="color: green; margin-top: 10px;"></p>
                    </div>
                </div>
            `;

            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const btn = document.getElementById('save-settings-btn');
                btn.disabled = true;
                btn.textContent = '‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

                try {
                    const newPassMark = Number(document.getElementById('pass-mark').value);
                    const newGrades = {};
                    gradeOrder.forEach(grade => {
                        newGrades[grade] = Number(document.getElementById(`grade-${grade}`).value);
                    });

                    const newSettings = {
                        passMark: newPassMark,
                        grades: newGrades
                    };
                    
                    await setDoc(doc(db, "settings", "grading"), newSettings);
                    
                    gradingSettings = newSettings;
                    
                    const successMsg = document.getElementById('settings-success-msg');
                    successMsg.textContent = '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!';
                    setTimeout(() => successMsg.textContent = '', 3000);
                } catch (error) {
                    console.error("Failed to save settings: ", error);
                    alert("‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                } finally {
                    btn.disabled = false;
                    btn.textContent = '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
                }
            });
        }
    </script>
</body>

</html>
